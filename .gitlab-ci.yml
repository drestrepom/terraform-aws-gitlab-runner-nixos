# GitLab CI configuration for NixOS Flake
stages:
  - lint
  - test
  - validate

# Shell Script Linting
shellcheck-lint:
  stage: lint
  tags:
    - nixos
    - arm64
    - shell
  script:
    - echo "üîç Running ShellCheck linting..."
    - nix run .#shellcheck lint
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# Nix Linting
nix-lint:
  stage: lint
  tags:
    - nixos
    - arm64
    - shell
  script:
    - echo "üîç Running Nix linting..."
    - nix run .#nix-lint lint
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# Terraform Linting
terraform-lint:
  stage: lint
  tags:
    - nixos
    - arm64
    - shell
  script:
    - echo "üîç Running Terraform linting..."
    - nix run .#infra lint
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# Terraform Validation
terraform-validate:
  stage: validate
  tags:
    - nixos
    - arm64
    - shell
  script:
    - echo "‚úÖ Running Terraform validation..."
    - nix run .#infra validate
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
